<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1a1a2e">
    <title>ğŸŒ ä¸–ç•Œå¤©æ°£é å ±</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸŒ¤ï¸</text></svg>">
    <style>
        :root { --primary:#4facfe; --secondary:#00f2fe; --glass:rgba(255,255,255,0.08); --border:rgba(255,255,255,0.15); }
        * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
        body { font-family:-apple-system,BlinkMacSystemFont,'Noto Sans TC',sans-serif; min-height:100vh; color:#fff; }
        
        /* èƒŒæ™¯ */
        .bg { position:fixed; top:0; left:0; width:100%; height:100%; z-index:-1; transition:background 1.5s; }
        .bg.sunny { background:linear-gradient(180deg,#4facfe 0%,#00f2fe 50%,#f6d365 100%); }
        .bg.cloudy { background:linear-gradient(180deg,#606c88 0%,#3f4c6b 50%,#2c3e50 100%); }
        .bg.rainy { background:linear-gradient(180deg,#373b44 0%,#4286f4 50%,#373b44 100%); }
        .bg.night { background:linear-gradient(180deg,#0f0c29 0%,#302b63 50%,#24243e 100%); }
        .bg.default { background:linear-gradient(180deg,#1a1a2e 0%,#16213e 50%,#0f3460 100%); }
        
        /* ç²’å­ */
        .particles { position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; overflow:hidden; }
        .particle { position:absolute; width:4px; height:4px; background:rgba(255,255,255,0.3); border-radius:50%; animation:float 15s infinite linear; }
        @keyframes float { 0%{transform:translateY(100vh);opacity:0} 10%{opacity:1} 90%{opacity:1} 100%{transform:translateY(-100vh);opacity:0} }
        
        /* é–‹æ©Ÿå‹•ç•« */
        #splash { position:fixed; top:0; left:0; width:100%; height:100%; background:linear-gradient(135deg,#667eea,#764ba2,#f093fb); display:flex; flex-direction:column; justify-content:center; align-items:center; z-index:9999; transition:opacity 0.8s,visibility 0.8s; }
        #splash.hide { opacity:0; visibility:hidden; }
        .splash-logo { position:relative; width:150px; height:150px; display:flex; justify-content:center; align-items:center; }
        .splash-char { font-size:80px; font-weight:900; color:#fff; text-shadow:0 0 60px rgba(255,255,255,0.8); animation:spin3d 3s ease-in-out infinite; }
        @keyframes spin3d { 0%{transform:rotateY(0) scale(1)} 50%{transform:rotateY(180deg) scale(1.1)} 100%{transform:rotateY(360deg) scale(1)} }
        .splash-glow { position:absolute; width:200px; height:200px; border-radius:50%; background:radial-gradient(circle,rgba(255,255,255,0.4),transparent 70%); animation:pulse 2s ease-in-out infinite; }
        @keyframes pulse { 0%,100%{transform:scale(1);opacity:0.5} 50%{transform:scale(1.3);opacity:0.8} }
        .splash-ring { position:absolute; width:180px; height:180px; border:3px solid rgba(255,255,255,0.3); border-top-color:#fff; border-radius:50%; animation:rotate 1.5s linear infinite; }
        @keyframes rotate { to{transform:rotate(360deg)} }
        .splash-title { font-size:28px; font-weight:700; margin-top:30px; background:linear-gradient(90deg,#fff,#f0abfc,#fff); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
        .splash-sub { font-size:14px; color:rgba(255,255,255,0.8); margin-top:10px; }
        .splash-bar { margin-top:40px; width:180px; height:4px; background:rgba(255,255,255,0.2); border-radius:2px; overflow:hidden; }
        .splash-bar::after { content:''; display:block; width:40%; height:100%; background:linear-gradient(90deg,transparent,#fff,transparent); animation:slide 1.2s ease-in-out infinite; }
        @keyframes slide { 0%{transform:translateX(-100%)} 100%{transform:translateX(350%)} }
        
        /* Header */
        .header { position:fixed; top:0; left:0; right:0; z-index:100; padding:12px 16px; background:rgba(0,0,0,0.3); backdrop-filter:blur(20px); border-bottom:1px solid rgba(255,255,255,0.1); }
        .header-inner { max-width:600px; margin:0 auto; display:flex; justify-content:space-between; align-items:center; }
        .header-title { display:flex; align-items:center; gap:8px; font-size:18px; font-weight:600; }
        .header-time { font-size:12px; color:rgba(255,255,255,0.7); }
        
        /* ä¸»å®¹å™¨ */
        .app { position:relative; z-index:1; min-height:100vh; padding:60px 16px 100px; }
        
        /* æœå°‹å€ */
        .search-sec { max-width:600px; margin:0 auto 20px; }
        .search-box { display:flex; gap:10px; position:relative; }
        .search-input { flex:1; padding:14px 18px; background:var(--glass); backdrop-filter:blur(10px); border:1px solid var(--border); border-radius:16px; color:#fff; font-size:16px; outline:none; }
        .search-input:focus { border-color:var(--primary); box-shadow:0 0 20px rgba(79,172,254,0.3); }
        .search-input::placeholder { color:rgba(255,255,255,0.4); }
        .search-btn { padding:14px 24px; background:linear-gradient(135deg,var(--primary),var(--secondary)); border:none; border-radius:16px; color:#fff; font-size:16px; font-weight:600; cursor:pointer; }
        .search-btn:disabled { opacity:0.6; }
        
        /* æœå°‹å»ºè­° */
        .suggestions { position:absolute; top:100%; left:0; right:60px; margin-top:8px; background:rgba(30,30,50,0.95); backdrop-filter:blur(20px); border:1px solid var(--border); border-radius:16px; max-height:280px; overflow-y:auto; display:none; z-index:50; }
        .suggestions.show { display:block; }
        .sug-item { padding:14px 18px; cursor:pointer; border-bottom:1px solid rgba(255,255,255,0.05); }
        .sug-item:hover { background:rgba(79,172,254,0.2); }
        .sug-city { font-size:15px; font-weight:500; }
        .sug-country { font-size:12px; color:rgba(255,255,255,0.6); margin-top:2px; }
        .sug-coords { font-size:10px; color:var(--primary); margin-top:4px; font-family:monospace; }
        
        /* API é¸æ“‡ */
        .api-sel { display:flex; gap:8px; margin-top:12px; flex-wrap:wrap; }
        .api-btn { padding:8px 14px; background:var(--glass); border:1px solid var(--border); border-radius:20px; color:rgba(255,255,255,0.7); font-size:12px; cursor:pointer; }
        .api-btn:hover { background:rgba(255,255,255,0.15); }
        .api-btn.active { background:linear-gradient(135deg,var(--primary),var(--secondary)); color:#fff; border-color:transparent; }
        
        /* å¿«é€ŸåŸå¸‚ */
        .quick-sec { margin-top:16px; }
        .quick-title { font-size:12px; color:rgba(255,255,255,0.6); margin-bottom:10px; }
        .quick-list { display:flex; gap:8px; overflow-x:auto; padding-bottom:8px; }
        .quick-list::-webkit-scrollbar { height:4px; }
        .quick-list::-webkit-scrollbar-thumb { background:rgba(255,255,255,0.2); border-radius:2px; }
        .quick-btn { flex-shrink:0; padding:10px 16px; background:var(--glass); border:1px solid var(--border); border-radius:20px; color:rgba(255,255,255,0.7); font-size:13px; cursor:pointer; white-space:nowrap; }
        .quick-btn:hover { background:rgba(255,255,255,0.15); color:#fff; border-color:var(--primary); }
        
        /* ç»ç’ƒå¡ç‰‡ */
        .card { background:var(--glass); backdrop-filter:blur(20px); border:1px solid var(--border); border-radius:24px; padding:24px; margin-bottom:16px; max-width:600px; margin-left:auto; margin-right:auto; }
        
        /* å¤©æ°£ä¸»å¡ç‰‡ */
        .weather-main { text-align:center; padding:30px 20px; }
        .w-city { font-size:28px; font-weight:600; }
        .w-country { font-size:14px; color:rgba(255,255,255,0.7); margin-bottom:20px; }
        .w-icon { font-size:100px; line-height:1; margin:20px 0; filter:drop-shadow(0 10px 30px rgba(0,0,0,0.3)); animation:wfloat 3s ease-in-out infinite; }
        @keyframes wfloat { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-10px)} }
        .w-temp { font-size:72px; font-weight:200; line-height:1; margin-bottom:10px; }
        .w-temp .unit { font-size:36px; vertical-align:super; }
        .w-desc { font-size:20px; color:rgba(255,255,255,0.7); margin-bottom:10px; }
        .w-feels { font-size:14px; color:rgba(255,255,255,0.7); }
        
        /* è©³ç´° */
        .details { display:grid; grid-template-columns:repeat(2,1fr); gap:12px; }
        .detail { background:rgba(255,255,255,0.05); border-radius:16px; padding:16px; text-align:center; }
        .detail-icon { font-size:24px; margin-bottom:8px; }
        .detail-label { font-size:11px; color:rgba(255,255,255,0.6); margin-bottom:4px; }
        .detail-val { font-size:18px; font-weight:600; }
        
        /* æ—¥å‡ºæ—¥è½ */
        .sun-row { display:flex; justify-content:space-around; padding:20px 0; }
        .sun-item { text-align:center; }
        .sun-icon { font-size:36px; margin-bottom:8px; }
        .sun-time { font-size:18px; font-weight:600; }
        .sun-label { font-size:12px; color:rgba(255,255,255,0.6); margin-top:4px; }
        
        /* è¡›æ˜Ÿ */
        .sat-card { position:relative; overflow:hidden; }
        .sat-card::before { content:''; position:absolute; top:-50%; left:-50%; width:200%; height:200%; background:conic-gradient(from 0deg,transparent,rgba(79,172,254,0.1),transparent); animation:orbit 10s linear infinite; }
        @keyframes orbit { to{transform:rotate(360deg)} }
        .sat-content { position:relative; z-index:1; }
        .sat-header { display:flex; align-items:center; gap:12px; margin-bottom:16px; }
        .sat-icon { font-size:32px; animation:satpulse 2s ease-in-out infinite; }
        @keyframes satpulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.1)} }
        .sat-title { font-size:16px; font-weight:600; }
        .sat-sub { font-size:12px; color:rgba(255,255,255,0.6); }
        .sat-row { display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid rgba(255,255,255,0.1); }
        .sat-row:last-child { border-bottom:none; }
        .sat-label { font-size:13px; color:rgba(255,255,255,0.6); }
        .sat-val { font-size:14px; font-weight:500; color:var(--primary); }
        .coords { display:flex; gap:20px; justify-content:center; margin-top:16px; padding:16px; background:rgba(0,0,0,0.2); border-radius:12px; }
        .coord { text-align:center; }
        .coord-label { font-size:10px; color:rgba(255,255,255,0.6); }
        .coord-val { font-size:16px; font-weight:600; font-family:monospace; color:var(--secondary); }
        
        /* APIä¾†æº */
        .api-src { display:flex; align-items:center; justify-content:center; gap:8px; padding:12px; font-size:11px; color:rgba(255,255,255,0.6); }
        .api-badge { padding:4px 10px; background:rgba(79,172,254,0.2); border-radius:10px; color:var(--primary); font-weight:500; }
        .update-time { text-align:center; font-size:12px; color:rgba(255,255,255,0.6); margin-top:16px; }
        
        /* ç”Ÿæˆåœ–ç‰‡æŒ‰éˆ• */
        .gen-btn { display:block; width:calc(100% - 40px); max-width:560px; margin:20px auto; padding:18px; background:linear-gradient(135deg,#667eea,#764ba2); border:none; border-radius:30px; color:#fff; font-size:18px; font-weight:700; cursor:pointer; box-shadow:0 4px 20px rgba(102,126,234,0.5); transition:all 0.3s; }
        .gen-btn:hover { transform:scale(1.02); box-shadow:0 6px 25px rgba(102,126,234,0.6); }
        .gen-btn:disabled { opacity:0.6; }
        
        /* åœ–ç‰‡é è¦½é¢æ¿ */
        .image-panel { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); backdrop-filter:blur(10px); z-index:300; justify-content:center; align-items:center; padding:20px; }
        .image-panel.show { display:flex; }
        .image-panel-box { width:100%; max-width:700px; max-height:90vh; background:rgba(20,20,40,0.98); border-radius:24px; overflow:hidden; border:1px solid rgba(255,255,255,0.1); display:flex; flex-direction:column; }
        .image-panel-header { display:flex; justify-content:space-between; align-items:center; padding:16px 20px; background:linear-gradient(135deg,#667eea,#764ba2); }
        .image-panel-header span { font-size:18px; font-weight:600; color:#fff; }
        .image-panel-close { width:36px; height:36px; background:rgba(255,255,255,0.2); border:none; border-radius:50%; color:#fff; font-size:20px; cursor:pointer; }
        .image-preview-wrap { flex:1; overflow:auto; padding:20px; display:flex; justify-content:center; align-items:center; background:#0a0a15; }
        .image-preview { max-width:100%; max-height:400px; border-radius:12px; box-shadow:0 10px 40px rgba(0,0,0,0.5); }
        .image-actions { display:grid; grid-template-columns:repeat(2,1fr); gap:12px; padding:20px; background:rgba(255,255,255,0.03); }
        .img-btn { display:flex; flex-direction:column; align-items:center; gap:6px; padding:16px; border:none; border-radius:16px; cursor:pointer; transition:all 0.2s; }
        .img-btn:hover { transform:scale(1.03); }
        .img-btn-icon { font-size:28px; }
        .img-btn-text { font-size:13px; font-weight:600; }
        .img-btn.download { background:linear-gradient(135deg,#4facfe,#00f2fe); color:#fff; }
        .img-btn.share { background:linear-gradient(135deg,#f093fb,#f5576c); color:#fff; }
        .img-btn.line { background:linear-gradient(135deg,#06c755,#00a040); color:#fff; }
        .img-btn.upload { background:linear-gradient(135deg,#ff9f0a,#ff6b35); color:#fff; }
        .image-status { padding:12px 20px; font-size:13px; text-align:center; display:none; }
        .image-status.show { display:block; }
        .image-status.ok { background:rgba(48,209,88,0.15); color:#30d158; }
        .image-status.err { background:rgba(255,55,95,0.15); color:#ff375f; }
        .image-status.info { background:rgba(79,172,254,0.15); color:#4facfe; }
        
        /* è¼‰å…¥ */
        .loading { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); backdrop-filter:blur(5px); z-index:200; justify-content:center; align-items:center; flex-direction:column; }
        .loading.show { display:flex; }
        .spinner { width:60px; height:60px; border:3px solid rgba(255,255,255,0.1); border-top-color:var(--primary); border-radius:50%; animation:rotate 1s linear infinite; }
        .loading-text { margin-top:16px; font-size:14px; color:rgba(255,255,255,0.7); }
        
        /* Toast */
        #toast { position:fixed; bottom:100px; left:50%; transform:translateX(-50%) translateY(100px); padding:14px 28px; background:rgba(0,0,0,0.8); backdrop-filter:blur(10px); border-radius:30px; color:#fff; font-size:14px; z-index:300; opacity:0; transition:all 0.3s; white-space:nowrap; }
        #toast.show { transform:translateX(-50%) translateY(0); opacity:1; }
        
        /* åº•éƒ¨å°èˆª */
        .nav { position:fixed; bottom:0; left:0; right:0; padding:12px 16px 24px; background:rgba(0,0,0,0.4); backdrop-filter:blur(20px); border-top:1px solid rgba(255,255,255,0.1); z-index:100; }
        .nav-inner { max-width:600px; margin:0 auto; display:flex; justify-content:space-around; }
        .nav-btn { display:flex; flex-direction:column; align-items:center; gap:4px; padding:8px 16px; background:none; border:none; color:rgba(255,255,255,0.6); font-size:10px; cursor:pointer; }
        .nav-btn .icon { font-size:24px; }
        .nav-btn.active,.nav-btn:hover { color:var(--primary); }
        
        /* ========== è¨­å®šé¢æ¿ï¼ˆ6å€å¡Šï¼‰========== */
        .settings { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); backdrop-filter:blur(10px); z-index:250; justify-content:center; align-items:center; padding:20px; }
        .settings.show { display:flex; }
        .settings-box { width:100%; max-width:550px; max-height:85vh; overflow-y:auto; background:rgba(20,20,40,0.98); border-radius:24px; padding:24px; border:1px solid rgba(255,255,255,0.1); }
        .settings-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; position:sticky; top:0; background:rgba(20,20,40,0.98); padding-bottom:10px; border-bottom:1px solid rgba(255,255,255,0.1); }
        .settings-title { font-size:20px; font-weight:600; }
        .settings-close { width:36px; height:36px; background:rgba(255,255,255,0.1); border:none; border-radius:50%; color:#fff; font-size:20px; cursor:pointer; }
        
        /* èªè­‰å¡ç‰‡ */
        .auth-card { background:rgba(255,255,255,0.03); border-radius:16px; padding:18px; margin-bottom:14px; border:1px solid rgba(255,255,255,0.08); }
        .auth-header { display:flex; align-items:center; gap:10px; margin-bottom:14px; padding-bottom:12px; border-bottom:1px solid rgba(255,255,255,0.08); }
        .auth-header h3 { font-size:14px; font-weight:600; }
        .auth-tag { font-size:9px; padding:3px 8px; border-radius:4px; margin-left:auto; }
        .auth-tag.free { background:#30d158; color:#000; }
        .auth-tag.need { background:#ff9f0a; color:#000; }
        .auth-field { margin-bottom:14px; }
        .auth-field:last-child { margin-bottom:0; }
        .field-top { display:flex; align-items:center; gap:8px; margin-bottom:8px; }
        .field-top label { font-size:13px; font-weight:500; }
        .field-top .badge { font-size:9px; padding:2px 6px; border-radius:4px; }
        .field-top .badge.req { background:#ff375f; color:#fff; }
        .field-top .badge.opt { background:#636366; color:#fff; }
        .field-top .mark { font-size:10px; color:#30d158; margin-left:auto; }
        .auth-input { width:100%; padding:12px 14px; background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.12); border-radius:10px; color:#fff; font-size:14px; }
        .auth-input:focus { outline:none; border-color:var(--primary); }
        .auth-hint { font-size:10px; color:rgba(255,255,255,0.5); margin:6px 0 10px; line-height:1.5; }
        .auth-hint a { color:var(--primary); }
        .auth-btns { display:flex; gap:8px; }
        .auth-btn { flex:1; padding:10px; border:none; border-radius:8px; font-size:12px; font-weight:600; cursor:pointer; }
        .auth-btn:disabled { opacity:0.5; }
        .auth-btn.save { background:linear-gradient(135deg,#30d158,#28a745); color:#fff; }
        .auth-btn.clear { background:rgba(255,55,95,0.15); color:#ff375f; border:1px solid rgba(255,55,95,0.3); }
        .auth-btn.test-line { width:100%; padding:14px; background:linear-gradient(135deg,#06c755,#00a040); color:#fff; margin-top:14px; font-size:14px; }
        .auth-btn.test-line:disabled { opacity:0.6; }
        
        /* å…¨åŸŸæ“ä½œæŒ‰éˆ• */
        .global-actions { background:rgba(79,172,254,0.1); border-color:rgba(79,172,254,0.3); }
        .auth-btns-global { display:flex; gap:12px; }
        .auth-btn.save-all { flex:1; padding:16px; background:linear-gradient(135deg,#4facfe,#00f2fe); color:#fff; font-size:15px; font-weight:700; }
        .auth-btn.clear-all { flex:1; padding:16px; background:rgba(255,55,95,0.2); color:#ff375f; border:2px solid rgba(255,55,95,0.4); font-size:15px; font-weight:700; }
        .auth-btn.clear-all:hover { background:rgba(255,55,95,0.3); }
        
        .auth-status { font-size:11px; padding:8px 12px; border-radius:8px; margin-top:8px; display:none; text-align:center; }
        .auth-status.show { display:block; }
        .auth-status.ok { background:rgba(48,209,88,0.15); color:#30d158; }
        .auth-status.err { background:rgba(255,55,95,0.15); color:#ff375f; }
        .auth-status.info { background:rgba(79,172,254,0.15); color:#4facfe; }
        
        /* å…è²»æ¨™ç¤º */
        .free-box { background:rgba(48,209,88,0.1); border:1px solid rgba(48,209,88,0.3); border-radius:12px; padding:16px; text-align:center; }
        .free-box .ic { font-size:28px; }
        .free-box .tx { font-size:13px; color:#30d158; margin-top:6px; }
        .free-box .stx { font-size:10px; color:rgba(255,255,255,0.5); margin-top:4px; }
        
        /* æ­¡è¿ */
        .welcome { text-align:center; padding:60px 20px; }
        .welcome-icon { font-size:80px; margin-bottom:20px; animation:wfloat 3s ease-in-out infinite; }
        .welcome-title { font-size:24px; font-weight:600; margin-bottom:10px; }
        .welcome-sub { font-size:14px; color:rgba(255,255,255,0.6); line-height:1.6; }
        
        @media(max-width:480px) { .w-temp{font-size:60px} .w-icon{font-size:80px} .w-city{font-size:24px} }
    </style>
</head>
<body>
    <!-- é–‹æ©Ÿå‹•ç•« -->
    <div id="splash">
        <div class="splash-logo">
            <div class="splash-glow"></div>
            <div class="splash-ring"></div>
            <div class="splash-char">å¤©</div>
        </div>
        <div class="splash-title">ä¸–ç•Œå¤©æ°£é å ±</div>
        <div class="splash-sub">World Weather Forecast</div>
        <div class="splash-bar"></div>
    </div>

    <div class="bg default" id="bg"></div>
    <div class="particles" id="particles"></div>

    <header class="header">
        <div class="header-inner">
            <div class="header-title"><span>ğŸŒ</span><span>ä¸–ç•Œå¤©æ°£é å ±</span></div>
            <div class="header-time" id="time">--:--</div>
        </div>
    </header>

    <div class="app">
        <section class="search-sec">
            <div class="search-box">
                <input type="text" class="search-input" id="cityInput" placeholder="è¼¸å…¥åŸå¸‚åç¨±ï¼ˆæ”¯æ´å…¨çƒæœå°‹ï¼‰" autocomplete="off">
                <button class="search-btn" onclick="search()">ğŸ”</button>
                <div class="suggestions" id="sug"></div>
            </div>
            
            <div class="api-sel">
                <button class="api-btn active" data-api="auto" onclick="setApi('auto')">ğŸ¤– è‡ªå‹•</button>
                <button class="api-btn" data-api="meteo" onclick="setApi('meteo')">ğŸŒ Open-Meteo</button>
                <button class="api-btn" data-api="cwa" onclick="setApi('cwa')">ğŸ‡¹ğŸ‡¼ æ°£è±¡ç½²</button>
                <button class="api-btn" data-api="weatherapi" onclick="setApi('weatherapi')">âš¡ WeatherAPI</button>
                <button class="api-btn" data-api="owm" onclick="setApi('owm')">ğŸŒ¤ï¸ OWM</button>
            </div>
            
            <div class="quick-sec">
                <div class="quick-title">âš¡ å¿«é€Ÿé¸æ“‡</div>
                <div class="quick-list">
                    <button class="quick-btn" onclick="quick('å°åŒ—')">ğŸ‡¹ğŸ‡¼ å°åŒ—</button>
                    <button class="quick-btn" onclick="quick('é«˜é›„')">ğŸ‡¹ğŸ‡¼ é«˜é›„</button>
                    <button class="quick-btn" onclick="quick('æ±äº¬')">ğŸ‡¯ğŸ‡µ æ±äº¬</button>
                    <button class="quick-btn" onclick="quick('é¦–çˆ¾')">ğŸ‡°ğŸ‡· é¦–çˆ¾</button>
                    <button class="quick-btn" onclick="quick('é¦™æ¸¯')">ğŸ‡­ğŸ‡° é¦™æ¸¯</button>
                    <button class="quick-btn" onclick="quick('æ–°åŠ å¡')">ğŸ‡¸ğŸ‡¬ æ–°åŠ å¡</button>
                    <button class="quick-btn" onclick="quick('ç´ç´„')">ğŸ‡ºğŸ‡¸ ç´ç´„</button>
                    <button class="quick-btn" onclick="quick('å€«æ•¦')">ğŸ‡¬ğŸ‡§ å€«æ•¦</button>
                    <button class="quick-btn" onclick="quick('å·´é»')">ğŸ‡«ğŸ‡· å·´é»</button>
                    <button class="quick-btn" onclick="quick('é›ªæ¢¨')">ğŸ‡¦ğŸ‡º é›ªæ¢¨</button>
                </div>
            </div>
        </section>

        <div id="result">
            <div class="card welcome">
                <div class="welcome-icon">ğŸŒ¤ï¸</div>
                <div class="welcome-title">æŸ¥è©¢ä¸–ç•Œå„åœ°å¤©æ°£</div>
                <div class="welcome-sub">æ”¯æ´å…¨çƒåŸå¸‚è‡ªç”±æœå°‹<br>è¼¸å…¥åŸå¸‚åç¨±æˆ–é»æ“Šå¿«é€ŸæŒ‰éˆ•</div>
            </div>
        </div>
    </div>

    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div class="loading-text" id="loadingText">æ­£åœ¨å–å¾—å¤©æ°£...</div>
    </div>

    <div id="toast"></div>

    <nav class="nav">
        <div class="nav-inner">
            <button class="nav-btn active" onclick="showPage('home',this)"><span class="icon">ğŸ </span><span>é¦–é </span></button>
            <button class="nav-btn" onclick="showPage('settings',this)"><span class="icon">âš™ï¸</span><span>è¨­å®š</span></button>
        </div>
    </nav>

    <!-- ========== è¨­å®šé¢æ¿ï¼ˆ6 å€‹èªè­‰å€å¡Šï¼‰========== -->
    <div class="settings" id="settings">
        <div class="settings-box">
            <div class="settings-header">
                <div class="settings-title">âš™ï¸ API èªè­‰è¨­å®š</div>
                <button class="settings-close" onclick="closeSetting()">âœ•</button>
            </div>

            <!-- 1. LINE Bot èªè­‰ -->
            <div class="auth-card">
                <div class="auth-header">
                    <h3>ğŸ¤– LINE Bot èªè­‰</h3>
                    <span class="auth-tag need">éœ€è¨­å®š</span>
                </div>
                
                <div class="auth-field">
                    <div class="field-top">
                        <label>GAS éƒ¨ç½² URL</label>
                        <span class="badge req">å¿…å¡«</span>
                        <span class="mark" id="gasUrl_m"></span>
                    </div>
                    <input type="text" class="auth-input" id="gasUrl" placeholder="https://script.google.com/macros/s/...">
                    <div class="auth-hint">éƒ¨ç½² Code.gs å¾Œå–å¾—çš„ç¶²å€</div>
                    <div class="auth-btns">
                        <button class="auth-btn save" onclick="saveKey('gasUrl')">ğŸ’¾ å„²å­˜</button>
                        <button class="auth-btn clear" onclick="clearKey('gasUrl')">ğŸ—‘ï¸ æ¸…é™¤</button>
                    </div>
                    <div class="auth-status" id="gasUrl_s"></div>
                </div>

                <div class="auth-hint" style="background:rgba(48,209,88,0.1);padding:12px;border-radius:8px;margin-bottom:12px;border:1px solid rgba(48,209,88,0.3)">
                    âš ï¸ <strong>LINE Token è«‹åœ¨ GAS è¨­å®šé é¢å„²å­˜</strong><br>
                    <span style="font-size:10px;color:#8e8e93">é–‹å•Ÿ GAS éƒ¨ç½²ç¶²å€ â†’ å¡«å…¥ Channel Access Token â†’ å„²å­˜</span>
                </div>

                <div class="auth-field">
                    <div class="field-top">
                        <label>User IDï¼ˆæ¨é€å°è±¡ï¼‰</label>
                        <span class="badge req">å¿…å¡«</span>
                        <span class="mark" id="lineUserId_m"></span>
                    </div>
                    <input type="text" class="auth-input" id="lineUserId" placeholder="U1234567890abcdef...">
                    <div class="auth-hint">å° Bot å‚³é€ã€Œæˆ‘çš„IDã€æˆ–ã€Œ/myidã€å–å¾—</div>
                    <div class="auth-btns">
                        <button class="auth-btn save" onclick="saveKey('lineUserId')">ğŸ’¾ å„²å­˜</button>
                        <button class="auth-btn clear" onclick="clearKey('lineUserId')">ğŸ—‘ï¸ æ¸…é™¤</button>
                    </div>
                    <div class="auth-status" id="lineUserId_s"></div>
                </div>

                <button class="auth-btn test-line" onclick="testLineConnection()">ğŸ“¤ ç™¼é€æª¢æ¸¬å›å ±åˆ° LINE</button>
                <div class="auth-status" id="testLine_s"></div>
            </div>

            <!-- 2. Open-Meteo -->
            <div class="auth-card">
                <div class="auth-header">
                    <h3>ğŸŒ Open-Meteo</h3>
                    <span class="auth-tag free">å…è²»å…Key</span>
                </div>
                <div class="free-box">
                    <div class="ic">âœ…</div>
                    <div class="tx">è‡ªå‹•å¯ç”¨ï¼Œç„¡éœ€è¨­å®šï¼</div>
                    <div class="stx">å…¨çƒå¤©æ°£è³‡æ–™ï¼Œå®Œå…¨å…è²»ï¼Œç„¡é™åˆ¶</div>
                </div>
            </div>

            <!-- 3. å°ç£æ°£è±¡ç½² CWA -->
            <div class="auth-card">
                <div class="auth-header">
                    <h3>ğŸ‡¹ğŸ‡¼ å°ç£æ°£è±¡ç½² CWA</h3>
                    <span class="auth-tag need">éœ€ç”³è«‹</span>
                </div>
                <div class="auth-field">
                    <div class="field-top">
                        <label>CWA æˆæ¬Šç¢¼</label>
                        <span class="badge opt">é¸å¡«</span>
                        <span class="mark" id="cwaKey_m"></span>
                    </div>
                    <input type="password" class="auth-input" id="cwaKey" placeholder="CWA-XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX">
                    <div class="auth-hint"><a href="https://opendata.cwa.gov.tw/user/authkey" target="_blank">æ°£è±¡è³‡æ–™é–‹æ”¾å¹³å°</a> â†’ ç™»å…¥/è¨»å†Š â†’ å–å¾—æˆæ¬Šç¢¼<br>å°ç£åœ°å€æœ€æº–ç¢ºçš„æ°£è±¡è³‡æ–™</div>
                    <div class="auth-btns">
                        <button class="auth-btn save" onclick="saveKey('cwaKey')">ğŸ’¾ å„²å­˜</button>
                        <button class="auth-btn clear" onclick="clearKey('cwaKey')">ğŸ—‘ï¸ æ¸…é™¤</button>
                    </div>
                    <div class="auth-status" id="cwaKey_s"></div>
                </div>
            </div>

            <!-- 4. WeatherAPI -->
            <div class="auth-card">
                <div class="auth-header">
                    <h3>âš¡ WeatherAPI</h3>
                    <span class="auth-tag need">éœ€ç”³è«‹</span>
                </div>
                <div class="auth-field">
                    <div class="field-top">
                        <label>API Key</label>
                        <span class="badge opt">é¸å¡«</span>
                        <span class="mark" id="weatherApiKey_m"></span>
                    </div>
                    <input type="password" class="auth-input" id="weatherApiKey" placeholder="è¼¸å…¥ API Key">
                    <div class="auth-hint"><a href="https://www.weatherapi.com/" target="_blank">WeatherAPI.com</a> â†’ Sign Up â†’ å–å¾— API Key<br>å…è²»æ–¹æ¡ˆï¼š100 è¬æ¬¡/æœˆ</div>
                    <div class="auth-btns">
                        <button class="auth-btn save" onclick="saveKey('weatherApiKey')">ğŸ’¾ å„²å­˜</button>
                        <button class="auth-btn clear" onclick="clearKey('weatherApiKey')">ğŸ—‘ï¸ æ¸…é™¤</button>
                    </div>
                    <div class="auth-status" id="weatherApiKey_s"></div>
                </div>
            </div>

            <!-- 5. OpenWeatherMap -->
            <div class="auth-card">
                <div class="auth-header">
                    <h3>ğŸŒ¤ï¸ OpenWeatherMap</h3>
                    <span class="auth-tag need">éœ€ç”³è«‹</span>
                </div>
                <div class="auth-field">
                    <div class="field-top">
                        <label>API Key</label>
                        <span class="badge opt">é¸å¡«</span>
                        <span class="mark" id="owmKey_m"></span>
                    </div>
                    <input type="password" class="auth-input" id="owmKey" placeholder="è¼¸å…¥ API Key">
                    <div class="auth-hint"><a href="https://openweathermap.org/api" target="_blank">OpenWeatherMap</a> â†’ Sign Up â†’ API Keys<br>å…è²»æ–¹æ¡ˆï¼š1,000 æ¬¡/æ—¥</div>
                    <div class="auth-btns">
                        <button class="auth-btn save" onclick="saveKey('owmKey')">ğŸ’¾ å„²å­˜</button>
                        <button class="auth-btn clear" onclick="clearKey('owmKey')">ğŸ—‘ï¸ æ¸…é™¤</button>
                    </div>
                    <div class="auth-status" id="owmKey_s"></div>
                </div>
            </div>

            <!-- 6. ImgBB -->
            <div class="auth-card">
                <div class="auth-header">
                    <h3>ğŸ–¼ï¸ ImgBB åœ–åºŠ</h3>
                    <span class="auth-tag need">éœ€ç”³è«‹</span>
                </div>
                <div class="auth-field">
                    <div class="field-top">
                        <label>API Key</label>
                        <span class="badge opt">é¸å¡«</span>
                        <span class="mark" id="imgbbKey_m"></span>
                    </div>
                    <input type="password" class="auth-input" id="imgbbKey" placeholder="è¼¸å…¥ API Key">
                    <div class="auth-hint"><a href="https://api.imgbb.com/" target="_blank">ImgBB API</a> â†’ Get API Key<br>ç”¨æ–¼ LINE æ¨é€å¤©æ°£æˆªåœ–ï¼ˆé¸ç”¨ï¼‰</div>
                    <div class="auth-btns">
                        <button class="auth-btn save" onclick="saveKey('imgbbKey')">ğŸ’¾ å„²å­˜</button>
                        <button class="auth-btn clear" onclick="clearKey('imgbbKey')">ğŸ—‘ï¸ æ¸…é™¤</button>
                    </div>
                    <div class="auth-status" id="imgbbKey_s"></div>
                </div>
            </div>

            <!-- å…¨åŸŸæ“ä½œæŒ‰éˆ• -->
            <div class="auth-card global-actions">
                <div class="auth-btns-global">
                    <button class="auth-btn save-all" onclick="saveAllKeys()">ğŸ’¾ å„²å­˜æ‰€æœ‰è¨­å®š</button>
                    <button class="auth-btn clear-all" onclick="clearAllKeys()">ğŸ—‘ï¸ ä¸€éµæ¸…é™¤æ‰€æœ‰</button>
                </div>
                <div class="auth-status" id="global_s"></div>
            </div>

        </div>
    </div>

    <script>
    // ========== å…¨åŸŸè®Šæ•¸ ==========
    let currentApi = 'auto';
    let currentWeather = null;
    let searchTimer = null;
    
    // è¨­å®š Keys
    const KEYS = ['gasUrl', 'lineUserId', 'cwaKey', 'weatherApiKey', 'owmKey', 'imgbbKey'];
    let cfg = {};
    
    // å¿«é€ŸåŸå¸‚
    const QUICK = {
        'å°åŒ—':{lat:25.0330,lon:121.5654,country:'å°ç£'},
        'é«˜é›„':{lat:22.6273,lon:120.3014,country:'å°ç£'},
        'å°ä¸­':{lat:24.1477,lon:120.6736,country:'å°ç£'},
        'å°å—':{lat:22.9998,lon:120.2270,country:'å°ç£'},
        'æ±äº¬':{lat:35.6762,lon:139.6503,country:'æ—¥æœ¬'},
        'å¤§é˜ª':{lat:34.6937,lon:135.5023,country:'æ—¥æœ¬'},
        'é¦–çˆ¾':{lat:37.5665,lon:126.9780,country:'éŸ“åœ‹'},
        'é¦™æ¸¯':{lat:22.3193,lon:114.1694,country:'é¦™æ¸¯'},
        'æ–°åŠ å¡':{lat:1.3521,lon:103.8198,country:'æ–°åŠ å¡'},
        'æ›¼è°·':{lat:13.7563,lon:100.5018,country:'æ³°åœ‹'},
        'ç´ç´„':{lat:40.7128,lon:-74.0060,country:'ç¾åœ‹'},
        'æ´›æ‰ç£¯':{lat:34.0522,lon:-118.2437,country:'ç¾åœ‹'},
        'å€«æ•¦':{lat:51.5074,lon:-0.1278,country:'è‹±åœ‹'},
        'å·´é»':{lat:48.8566,lon:2.3522,country:'æ³•åœ‹'},
        'é›ªæ¢¨':{lat:-33.8688,lon:151.2093,country:'æ¾³æ´²'}
    };
    
    const ICONS = {'Clear':'â˜€ï¸','Sunny':'â˜€ï¸','Clouds':'â˜ï¸','Cloudy':'â˜ï¸','Overcast':'â˜ï¸','Partly cloudy':'â›…','Rain':'ğŸŒ§ï¸','Light rain':'ğŸŒ¦ï¸','Heavy rain':'â›ˆï¸','Drizzle':'ğŸŒ¦ï¸','Thunderstorm':'â›ˆï¸','Snow':'â„ï¸','Fog':'ğŸŒ«ï¸','Mist':'ğŸŒ«ï¸','æ™´':'â˜€ï¸','å¤šé›²':'â›…','é™°':'â˜ï¸','é›¨':'ğŸŒ§ï¸','default':'ğŸŒ¤ï¸'};
    
    function getSatellite(lon) {
        if(lon>=120&&lon<=150) return {name:'å‘æ—¥è‘µ9è™Ÿ Himawari-9',op:'æ—¥æœ¬æ°£è±¡å»³ JMA',pos:'140.7Â°E',type:'éœæ­¢è»Œé“'};
        if(lon>=70&&lon<120) return {name:'é¢¨é›²å››è™ŸB FY-4B',op:'ä¸­åœ‹æ°£è±¡å±€ CMA',pos:'133Â°E',type:'éœæ­¢è»Œé“'};
        if(lon>=-20&&lon<70) return {name:'Meteosat-11',op:'EUMETSAT',pos:'0Â°',type:'éœæ­¢è»Œé“'};
        if(lon>=-180&&lon<-100) return {name:'GOES-18 West',op:'NOAA',pos:'137.2Â°W',type:'éœæ­¢è»Œé“'};
        if(lon>=-100&&lon<-20) return {name:'GOES-16 East',op:'NOAA',pos:'75.2Â°W',type:'éœæ­¢è»Œé“'};
        return {name:'NOAA-20/21',op:'NOAA',pos:'æ¥µè»Œè¡›æ˜Ÿ',type:'æ¥µè»Œé“'};
    }
    
    // ========== åˆå§‹åŒ– ==========
    document.addEventListener('DOMContentLoaded', () => {
        loadAllKeys();
        setTimeout(() => document.getElementById('splash').classList.add('hide'), 2500);
        createParticles();
        updateTime(); setInterval(updateTime, 1000);
        
        const inp = document.getElementById('cityInput');
        inp.addEventListener('keypress', e => { if(e.key==='Enter') search(); });
        inp.addEventListener('input', () => {
            clearTimeout(searchTimer);
            searchTimer = setTimeout(() => searchGeo(inp.value.trim()), 300);
        });
        inp.addEventListener('blur', () => setTimeout(() => document.getElementById('sug').classList.remove('show'), 200));
    });
    
    function createParticles() {
        const c = document.getElementById('particles');
        for(let i=0;i<30;i++) {
            const p = document.createElement('div');
            p.className = 'particle';
            p.style.left = Math.random()*100+'%';
            p.style.animationDuration = (10+Math.random()*20)+'s';
            p.style.animationDelay = Math.random()*10+'s';
            p.style.width = p.style.height = (2+Math.random()*4)+'px';
            c.appendChild(p);
        }
    }
    
    function updateTime() {
        const d = new Date();
        document.getElementById('time').textContent = d.toLocaleDateString('zh-TW',{month:'short',day:'numeric',weekday:'short'})+' '+d.toLocaleTimeString('zh-TW',{hour:'2-digit',minute:'2-digit'});
    }
    
    // ========== è¨­å®šç®¡ç†ï¼ˆç¨ç«‹å„²å­˜/æ¸…é™¤ï¼‰==========
    function loadAllKeys() {
        KEYS.forEach(k => {
            cfg[k] = localStorage.getItem('weather_' + k) || '';
            document.getElementById(k).value = cfg[k];
            document.getElementById(k + '_m').textContent = cfg[k] ? 'âœ“ å·²è¨­å®š' : '';
        });
    }
    
    function saveKey(key) {
        const val = document.getElementById(key).value.trim();
        const status = document.getElementById(key + '_s');
        const mark = document.getElementById(key + '_m');
        
        localStorage.setItem('weather_' + key, val);
        cfg[key] = val;
        
        status.textContent = val ? 'âœ… å·²å„²å­˜' : 'âœ… å·²æ¸…ç©º';
        status.className = 'auth-status show ok';
        mark.textContent = val ? 'âœ“ å·²è¨­å®š' : '';
        
        setTimeout(() => status.className = 'auth-status', 2500);
        toast('ğŸ’¾ ' + key + ' å·²å„²å­˜');
    }
    
    function clearKey(key) {
        if (!confirm('ç¢ºå®šè¦æ¸…é™¤æ­¤è¨­å®šå—ï¼Ÿ')) return;
        
        document.getElementById(key).value = '';
        localStorage.removeItem('weather_' + key);
        cfg[key] = '';
        
        const status = document.getElementById(key + '_s');
        const mark = document.getElementById(key + '_m');
        
        status.textContent = 'ğŸ—‘ï¸ å·²æ¸…é™¤';
        status.className = 'auth-status show ok';
        mark.textContent = '';
        
        setTimeout(() => status.className = 'auth-status', 2000);
    }
    
    // å„²å­˜æ‰€æœ‰è¨­å®š
    function saveAllKeys() {
        const status = document.getElementById('global_s');
        let count = 0;
        
        KEYS.forEach(k => {
            const val = document.getElementById(k).value.trim();
            localStorage.setItem('weather_' + k, val);
            cfg[k] = val;
            document.getElementById(k + '_m').textContent = val ? 'âœ“ å·²è¨­å®š' : '';
            if (val) count++;
        });
        
        status.textContent = `âœ… å·²å„²å­˜æ‰€æœ‰è¨­å®šï¼ˆ${count}/${KEYS.length} é …å·²å¡«å¯«ï¼‰`;
        status.className = 'auth-status show ok';
        toast('ğŸ’¾ å·²å„²å­˜æ‰€æœ‰è¨­å®š');
        
        setTimeout(() => status.className = 'auth-status', 3000);
    }
    
    // ä¸€éµæ¸…é™¤æ‰€æœ‰
    function clearAllKeys() {
        if (!confirm('âš ï¸ ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰èªè­‰è³‡æ–™å—ï¼Ÿ\n\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) return;
        if (!confirm('ğŸš¨ å†æ¬¡ç¢ºèªï¼šçœŸçš„è¦æ¸…é™¤å…¨éƒ¨å—ï¼Ÿ')) return;
        
        const status = document.getElementById('global_s');
        
        KEYS.forEach(k => {
            document.getElementById(k).value = '';
            localStorage.removeItem('weather_' + k);
            cfg[k] = '';
            document.getElementById(k + '_m').textContent = '';
        });
        
        status.textContent = 'ğŸ—‘ï¸ å·²æ¸…é™¤æ‰€æœ‰èªè­‰è³‡æ–™';
        status.className = 'auth-status show ok';
        toast('ğŸ—‘ï¸ å·²æ¸…é™¤æ‰€æœ‰èªè­‰è³‡æ–™');
        
        setTimeout(() => status.className = 'auth-status', 3000);
    }
    
    // æ¸¬è©¦ LINE é€£ç·š
    async function testLineConnection() {
        if (!cfg.gasUrl) { toast('âš ï¸ è«‹å…ˆè¨­å®š GAS URL'); return; }
        if (!cfg.lineUserId) { toast('âš ï¸ è«‹å…ˆè¨­å®š User ID'); return; }
        
        const btn = document.querySelector('.auth-btn.test-line');
        const status = document.getElementById('testLine_s');
        
        btn.disabled = true;
        btn.textContent = 'ğŸ“¤ ç™¼é€ä¸­...';
        status.textContent = 'æ­£åœ¨ç™¼é€æ¸¬è©¦è¨Šæ¯...';
        status.className = 'auth-status show info';
        
        try {
            await fetch(cfg.gasUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
                body: JSON.stringify({
                    action: 'testConnection',
                    userId: cfg.lineUserId
                }),
                mode: 'no-cors'
            });
            
            status.textContent = 'âœ… å·²ç™¼é€ï¼è«‹æŸ¥çœ‹ LINE è¨Šæ¯';
            status.className = 'auth-status show ok';
        } catch (e) {
            status.textContent = 'âŒ ç™¼é€å¤±æ•—ï¼š' + e.message;
            status.className = 'auth-status show err';
        } finally {
            btn.disabled = false;
            btn.textContent = 'ğŸ“¤ ç™¼é€æª¢æ¸¬å›å ±åˆ° LINE';
            setTimeout(() => status.className = 'auth-status', 5000);
        }
    }
    
    // ========== Geocoding ==========
    async function searchGeo(q) {
        if(!q || q.length<2) { document.getElementById('sug').classList.remove('show'); return; }
        try {
            const r = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(q)}&count=8&language=zh&format=json`);
            const d = await r.json();
            if(d.results?.length) {
                document.getElementById('sug').innerHTML = d.results.map(x => `
                    <div class="sug-item" onclick="select(${x.latitude},${x.longitude},'${x.name}','${x.country||''}')">
                        <div class="sug-city">${x.name}</div>
                        <div class="sug-country">${x.admin1?x.admin1+', ':''}${x.country||''}</div>
                        <div class="sug-coords">ğŸ“ ${x.latitude.toFixed(4)}Â°, ${x.longitude.toFixed(4)}Â°</div>
                    </div>
                `).join('');
                document.getElementById('sug').classList.add('show');
            } else {
                document.getElementById('sug').classList.remove('show');
            }
        } catch(e) { console.error(e); }
    }
    
    function select(lat, lon, name, country) {
        document.getElementById('cityInput').value = name;
        document.getElementById('sug').classList.remove('show');
        fetchWeather(lat, lon, name, country);
    }
    
    function setApi(api) {
        currentApi = api;
        document.querySelectorAll('.api-btn').forEach(b => b.classList.toggle('active', b.dataset.api===api));
        toast('å·²åˆ‡æ›è‡³ ' + {auto:'è‡ªå‹•',meteo:'Open-Meteo',cwa:'æ°£è±¡ç½²',weatherapi:'WeatherAPI',owm:'OpenWeatherMap'}[api]);
    }
    
    function quick(city) {
        document.getElementById('cityInput').value = city;
        const d = QUICK[city];
        if(d) fetchWeather(d.lat, d.lon, city, d.country);
    }
    
    async function search() {
        const city = document.getElementById('cityInput').value.trim();
        if(!city) { toast('âš ï¸ è«‹è¼¸å…¥åŸå¸‚'); return; }
        if(QUICK[city]) { quick(city); return; }
        
        showLoad(true, 'æœå°‹åŸå¸‚ä¸­...');
        try {
            const r = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(city)}&count=1&language=zh&format=json`);
            const d = await r.json();
            if(d.results?.length) {
                const x = d.results[0];
                fetchWeather(x.latitude, x.longitude, x.name, x.country);
            } else {
                showLoad(false); toast('âŒ æ‰¾ä¸åˆ°æ­¤åŸå¸‚');
            }
        } catch(e) { showLoad(false); toast('âŒ æœå°‹å¤±æ•—'); }
    }
    
    // ========== å¤©æ°£æŸ¥è©¢ ==========
    async function fetchWeather(lat, lon, city, country) {
        showLoad(true, 'å–å¾—å¤©æ°£è³‡æ–™...');
        document.getElementById('sug').classList.remove('show');
        
        try {
            let data, api = currentApi;
            
            if(api === 'auto') {
                if(country === 'å°ç£' && cfg.cwaKey) api = 'cwa';
                else if(cfg.owmKey) api = 'owm';
                else if(cfg.weatherApiKey) api = 'weatherapi';
                else api = 'meteo';
            }
            
            switch(api) {
                case 'cwa':
                    if(!cfg.cwaKey) { api='meteo'; data = await fetchMeteo(lat,lon); }
                    else data = await fetchCWA(lat, lon, city);
                    break;
                case 'owm':
                    if(!cfg.owmKey) { api='meteo'; data = await fetchMeteo(lat,lon); }
                    else data = await fetchOWM(lat,lon);
                    break;
                case 'weatherapi':
                    if(!cfg.weatherApiKey) { api='meteo'; data = await fetchMeteo(lat,lon); }
                    else data = await fetchWAPI(lat,lon);
                    break;
                default:
                    data = await fetchMeteo(lat,lon);
                    api = 'meteo';
            }
            
            data.city = city;
            data.country = country;
            data.lat = lat;
            data.lon = lon;
            data.satellite = getSatellite(lon);
            data.apiSource = {meteo:'Open-Meteo',cwa:'å°ç£æ°£è±¡ç½²',owm:'OpenWeatherMap',weatherapi:'WeatherAPI'}[api];
            data.updateTime = new Date().toLocaleString('zh-TW');
            data.icon = ICONS[data.condition] || ICONS[data.description] || ICONS.default;
            
            currentWeather = data;
            render(data);
            updateBg(data.condition);
        } catch(e) {
            console.error(e);
            toast('âŒ æŸ¥è©¢å¤±æ•—: ' + e.message);
        } finally {
            showLoad(false);
        }
    }
    
    async function fetchMeteo(lat, lon) {
        const r = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,apparent_temperature,weather_code,wind_speed_10m,cloud_cover,visibility&daily=sunrise,sunset&timezone=auto`);
        if(!r.ok) throw new Error('API å¤±æ•—');
        const d = await r.json();
        const codes = {0:'Clear',1:'Partly cloudy',2:'Partly cloudy',3:'Cloudy',45:'Fog',48:'Fog',51:'Drizzle',53:'Drizzle',55:'Drizzle',61:'Rain',63:'Rain',65:'Heavy rain',71:'Snow',73:'Snow',75:'Snow',80:'Rain',95:'Thunderstorm'};
        const c = codes[d.current.weather_code] || 'Clear';
        return {
            temp: Math.round(d.current.temperature_2m*10)/10,
            feels: Math.round(d.current.apparent_temperature*10)/10,
            condition: c, description: c,
            humidity: d.current.relative_humidity_2m,
            wind: Math.round(d.current.wind_speed_10m/3.6*10)/10,
            visibility: d.current.visibility ? Math.round(d.current.visibility/1000)+'km' : null,
            clouds: d.current.cloud_cover,
            sunrise: d.daily.sunrise[0]?.split('T')[1],
            sunset: d.daily.sunset[0]?.split('T')[1]
        };
    }
    
    async function fetchCWA(lat, lon, city) {
        const stations = {'è‡ºåŒ—':466920,'å°åŒ—':466920,'æ–°åŒ—':466881,'æ¡ƒåœ’':467050,'æ–°ç«¹':467571,'è‡ºä¸­':467490,'å°ä¸­':467490,'å½°åŒ–':467270,'å˜‰ç¾©':467480,'è‡ºå—':467410,'å°å—':467410,'é«˜é›„':467440,'å±æ±':467590,'å®œè˜­':467080,'èŠ±è“®':466990,'è‡ºæ±':467660,'å°æ±':467660};
        const stationId = stations[city] || 466920;
        const url = `https://opendata.cwa.gov.tw/api/v1/rest/datastore/O-A0003-001?Authorization=${cfg.cwaKey}&StationId=${stationId}`;
        const r = await fetch(url);
        if(!r.ok) throw new Error('CWA API å¤±æ•—');
        const d = await r.json();
        if(!d.records?.Station?.[0]) throw new Error('ç„¡è³‡æ–™');
        const s = d.records.Station[0];
        const we = s.WeatherElement;
        return {
            temp: parseFloat(we.AirTemperature) || 0,
            feels: parseFloat(we.AirTemperature) || 0,
            condition: we.Weather || 'Clear',
            description: we.Weather || 'æ™´',
            humidity: parseFloat(we.RelativeHumidity) || 0,
            wind: Math.round((parseFloat(we.WindSpeed) || 0)*10)/10,
            visibility: we.VisibilityDescription || null,
            clouds: null, sunrise: null, sunset: null
        };
    }
    
    async function fetchOWM(lat, lon) {
        const r = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${cfg.owmKey}&units=metric&lang=zh_tw`);
        if(!r.ok) throw new Error('OWM API å¤±æ•—');
        const d = await r.json();
        return {
            temp: Math.round(d.main.temp*10)/10,
            feels: Math.round(d.main.feels_like*10)/10,
            condition: d.weather[0].main,
            description: d.weather[0].description,
            humidity: d.main.humidity,
            wind: Math.round(d.wind.speed*10)/10,
            visibility: d.visibility ? Math.round(d.visibility/1000)+'km' : null,
            clouds: d.clouds?.all,
            sunrise: new Date(d.sys.sunrise*1000).toLocaleTimeString('zh-TW',{hour:'2-digit',minute:'2-digit'}),
            sunset: new Date(d.sys.sunset*1000).toLocaleTimeString('zh-TW',{hour:'2-digit',minute:'2-digit'})
        };
    }
    
    async function fetchWAPI(lat, lon) {
        const r = await fetch(`https://api.weatherapi.com/v1/current.json?key=${cfg.weatherApiKey}&q=${lat},${lon}&lang=zh`);
        if(!r.ok) throw new Error('WeatherAPI å¤±æ•—');
        const d = await r.json();
        return {
            temp: d.current.temp_c,
            feels: d.current.feelslike_c,
            condition: d.current.condition.text,
            description: d.current.condition.text,
            humidity: d.current.humidity,
            wind: Math.round(d.current.wind_kph/3.6*10)/10,
            visibility: d.current.vis_km+'km',
            clouds: d.current.cloud,
            sunrise: null, sunset: null
        };
    }
    
    function render(d) {
        document.getElementById('result').innerHTML = `
            <div class="card weather-main">
                <div class="w-city">${d.city}</div>
                <div class="w-country">${d.country||''}</div>
                <div class="w-icon">${d.icon}</div>
                <div class="w-temp">${d.temp}<span class="unit">Â°C</span></div>
                <div class="w-desc">${d.description}</div>
                <div class="w-feels">ğŸŒ¡ï¸ é«”æ„Ÿ ${d.feels}Â°C</div>
            </div>
            <div class="card">
                <div class="details">
                    <div class="detail"><div class="detail-icon">ğŸ’§</div><div class="detail-label">æ¿•åº¦</div><div class="detail-val">${d.humidity}%</div></div>
                    <div class="detail"><div class="detail-icon">ğŸ’¨</div><div class="detail-label">é¢¨é€Ÿ</div><div class="detail-val">${d.wind} m/s</div></div>
                    <div class="detail"><div class="detail-icon">ğŸ‘ï¸</div><div class="detail-label">èƒ½è¦‹åº¦</div><div class="detail-val">${d.visibility||'--'}</div></div>
                    <div class="detail"><div class="detail-icon">â˜ï¸</div><div class="detail-label">é›²é‡</div><div class="detail-val">${d.clouds!=null?d.clouds+'%':'--'}</div></div>
                </div>
            </div>
            ${d.sunrise&&d.sunset?`
            <div class="card">
                <div class="sun-row">
                    <div class="sun-item"><div class="sun-icon">ğŸŒ…</div><div class="sun-time">${d.sunrise}</div><div class="sun-label">æ—¥å‡º</div></div>
                    <div class="sun-item"><div class="sun-icon">ğŸŒ‡</div><div class="sun-time">${d.sunset}</div><div class="sun-label">æ—¥è½</div></div>
                </div>
            </div>`:''}
            <div class="card sat-card">
                <div class="sat-content">
                    <div class="sat-header">
                        <div class="sat-icon">ğŸ›°ï¸</div>
                        <div><div class="sat-title">æ°£è±¡è¡›æ˜Ÿè³‡è¨Š</div><div class="sat-sub">Weather Satellite</div></div>
                    </div>
                    <div class="sat-row"><span class="sat-label">è§€æ¸¬è¡›æ˜Ÿ</span><span class="sat-val">${d.satellite.name}</span></div>
                    <div class="sat-row"><span class="sat-label">ç‡Ÿé‹æ©Ÿæ§‹</span><span class="sat-val">${d.satellite.op}</span></div>
                    <div class="sat-row"><span class="sat-label">è¡›æ˜Ÿä½ç½®</span><span class="sat-val">${d.satellite.pos}</span></div>
                    <div class="sat-row"><span class="sat-label">è»Œé“é¡å‹</span><span class="sat-val">${d.satellite.type}</span></div>
                    <div class="coords">
                        <div class="coord"><div class="coord-label">ç·¯åº¦</div><div class="coord-val">${d.lat.toFixed(4)}Â°</div></div>
                        <div class="coord"><div class="coord-label">ç¶“åº¦</div><div class="coord-val">${d.lon.toFixed(4)}Â°</div></div>
                    </div>
                </div>
            </div>
            <div class="api-src"><span>ğŸ“¡ è³‡æ–™ä¾†æºï¼š</span><span class="api-badge">${d.apiSource}</span></div>
            <div class="update-time">ğŸ• ${d.updateTime}</div>
            <button class="gen-btn" onclick="generateImage()">ğŸ¨ ç”Ÿæˆå¤©æ°£åœ–ç‰‡</button>
        `;
    }
    
    function updateBg(cond) {
        const bg = document.getElementById('bg');
        bg.className = 'bg';
        const h = new Date().getHours();
        const night = h<6 || h>18;
        if(night) bg.classList.add('night');
        else if(/Rain|Drizzle|Thunder|é›¨/i.test(cond)) bg.classList.add('rainy');
        else if(/Cloud|Overcast|é™°|å¤šé›²/i.test(cond)) bg.classList.add('cloudy');
        else if(/Clear|Sunny|æ™´/i.test(cond)) bg.classList.add('sunny');
        else bg.classList.add('default');
    }
    
    // ========== åœ–ç‰‡é è¦½èˆ‡åˆ†äº«åŠŸèƒ½ ==========
    let generatedImageUrl = null;
    let generatedBase64 = null;
    
    async function generateImage() {
        if (!currentWeather) { toast('âš ï¸ è«‹å…ˆæŸ¥è©¢å¤©æ°£'); return; }
        
        showLoad(true, 'ğŸ¨ ç”Ÿæˆç²¾ç¾å¤©æ°£åœ–ç‰‡ä¸­...');
        
        try {
            generatedBase64 = await generateWeatherImage(currentWeather);
            generatedImageUrl = null; // é‡ç½®
            
            showImagePreview(generatedBase64);
            toast('âœ… åœ–ç‰‡ç”Ÿæˆå®Œæˆï¼');
        } catch (e) {
            console.error(e);
            toast('âŒ ç”Ÿæˆå¤±æ•—: ' + e.message);
        } finally {
            showLoad(false);
        }
    }
    
    function showImagePreview(base64) {
        let panel = document.getElementById('imagePanel');
        if (!panel) {
            panel = document.createElement('div');
            panel.id = 'imagePanel';
            panel.className = 'image-panel';
            document.body.appendChild(panel);
        }
        
        panel.innerHTML = `
            <div class="image-panel-box">
                <div class="image-panel-header">
                    <span>ğŸ–¼ï¸ å¤©æ°£åœ–ç‰‡é è¦½</span>
                    <button class="image-panel-close" onclick="closeImagePanel()">âœ•</button>
                </div>
                <div class="image-preview-wrap">
                    <img src="${base64}" class="image-preview" alt="å¤©æ°£åœ–ç‰‡">
                </div>
                <div class="image-actions">
                    <button class="img-btn download" onclick="downloadImage()">
                        <span class="img-btn-icon">ğŸ“¥</span>
                        <span class="img-btn-text">ä¸‹è¼‰ PNG</span>
                    </button>
                    <button class="img-btn share" onclick="shareImage()">
                        <span class="img-btn-icon">ğŸ“¤</span>
                        <span class="img-btn-text">ç³»çµ±åˆ†äº«</span>
                    </button>
                    <button class="img-btn line" onclick="pushToLine()">
                        <span class="img-btn-icon">ğŸ’¬</span>
                        <span class="img-btn-text">æ¨é€ LINE</span>
                    </button>
                    <button class="img-btn upload" onclick="uploadAndCopy()">
                        <span class="img-btn-icon">ğŸ”—</span>
                        <span class="img-btn-text">ä¸Šå‚³å–é€£çµ</span>
                    </button>
                </div>
                <div class="image-status" id="imageStatus"></div>
            </div>
        `;
        
        panel.classList.add('show');
    }
    
    function closeImagePanel() {
        const panel = document.getElementById('imagePanel');
        if (panel) panel.classList.remove('show');
    }
    
    // ä¸‹è¼‰ PNG
    function downloadImage() {
        if (!generatedBase64) return;
        
        const link = document.createElement('a');
        const filename = `weather_${currentWeather.city}_${new Date().toISOString().slice(0,10)}.png`;
        link.download = filename;
        link.href = generatedBase64;
        link.click();
        
        updateImageStatus('âœ… å·²ä¸‹è¼‰: ' + filename, 'ok');
    }
    
    // ç³»çµ±åˆ†äº«
    async function shareImage() {
        if (!generatedBase64) return;
        
        try {
            const res = await fetch(generatedBase64);
            const blob = await res.blob();
            const file = new File([blob], `weather_${currentWeather.city}.png`, { type: 'image/png' });
            
            if (navigator.share && navigator.canShare({ files: [file] })) {
                await navigator.share({
                    title: `${currentWeather.city} å¤©æ°£é å ±`,
                    text: `${currentWeather.icon} ${currentWeather.city} ${currentWeather.temp}Â°C ${currentWeather.description}`,
                    files: [file]
                });
                updateImageStatus('âœ… åˆ†äº«æˆåŠŸï¼', 'ok');
            } else if (navigator.share) {
                await navigator.share({
                    title: `${currentWeather.city} å¤©æ°£é å ±`,
                    text: `${currentWeather.icon} ${currentWeather.city} ${currentWeather.temp}Â°C ${currentWeather.description}\né«”æ„Ÿ ${currentWeather.feels}Â°C | æ¿•åº¦ ${currentWeather.humidity}%`
                });
                updateImageStatus('âœ… å·²åˆ†äº«æ–‡å­—', 'ok');
            } else {
                updateImageStatus('âš ï¸ æ­¤ç€è¦½å™¨ä¸æ”¯æ´åˆ†äº«', 'err');
            }
        } catch (e) {
            if (e.name !== 'AbortError') {
                updateImageStatus('âŒ åˆ†äº«å¤±æ•—', 'err');
            }
        }
    }
    
    // ä¸Šå‚³ä¸¦è¤‡è£½é€£çµ
    async function uploadAndCopy() {
        if (!generatedBase64) return;
        if (!cfg.imgbbKey) {
            updateImageStatus('âš ï¸ è«‹å…ˆè¨­å®š ImgBB API Key', 'err');
            return;
        }
        
        updateImageStatus('â³ ä¸Šå‚³ä¸­...', 'info');
        
        try {
            generatedImageUrl = await uploadToImgBB(generatedBase64);
            await navigator.clipboard.writeText(generatedImageUrl);
            updateImageStatus('âœ… å·²ä¸Šå‚³ä¸¦è¤‡è£½é€£çµï¼', 'ok');
        } catch (e) {
            updateImageStatus('âŒ ä¸Šå‚³å¤±æ•—: ' + e.message, 'err');
        }
    }
    
    // æ¨é€åˆ° LINE
    async function pushToLine() {
        if (!currentWeather) return;
        if (!cfg.gasUrl) { updateImageStatus('âš ï¸ è«‹å…ˆè¨­å®š GAS URL', 'err'); return; }
        if (!cfg.lineUserId) { updateImageStatus('âš ï¸ è«‹å…ˆè¨­å®š User ID', 'err'); return; }
        
        updateImageStatus('â³ æ¨é€åˆ° LINE...', 'info');
        
        try {
            await fetch(cfg.gasUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
                body: JSON.stringify({
                    action: 'pushWeather',
                    weather: currentWeather,
                    imageBase64: generatedBase64,
                    userId: cfg.lineUserId
                }),
                mode: 'no-cors'
            });
            
            updateImageStatus('âœ… å·²æ¨é€åˆ° LINEï¼', 'ok');
        } catch (e) {
            updateImageStatus('âŒ æ¨é€å¤±æ•—: ' + e.message, 'err');
        }
    }
    
    function updateImageStatus(msg, type) {
        const el = document.getElementById('imageStatus');
        if (el) {
            el.textContent = msg;
            el.className = 'image-status show ' + type;
        }
    }
    
    // ========== ç”Ÿæˆç²¾ç¾å¤©æ°£åœ–ç‰‡ ==========
    async function generateWeatherImage(w) {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 1200;
        canvas.height = 630;
        
        // èƒŒæ™¯æ¼¸å±¤
        const bgGrad = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
        bgGrad.addColorStop(0, '#0a0e27');
        bgGrad.addColorStop(0.5, '#1a1a3e');
        bgGrad.addColorStop(1, '#0d1b2a');
        ctx.fillStyle = bgGrad;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // é›»è·¯æ¿ç´‹ç†
        ctx.strokeStyle = 'rgba(79, 172, 254, 0.1)';
        ctx.lineWidth = 1;
        for (let i = 0; i < 20; i++) {
            const x = Math.random() * canvas.width;
            const y = Math.random() * canvas.height;
            ctx.beginPath();
            ctx.moveTo(x, y);
            ctx.lineTo(x + (Math.random() - 0.5) * 200, y + (Math.random() - 0.5) * 200);
            ctx.stroke();
            // ç¯€é»
            ctx.fillStyle = 'rgba(79, 172, 254, 0.3)';
            ctx.beginPath();
            ctx.arc(x, y, 3, 0, Math.PI * 2);
            ctx.fill();
        }
        
        // ç²’å­/æ˜Ÿæ˜Ÿ
        for (let i = 0; i < 50; i++) {
            const x = Math.random() * canvas.width;
            const y = Math.random() * canvas.height;
            const size = Math.random() * 2 + 1;
            ctx.fillStyle = `rgba(255, 255, 255, ${Math.random() * 0.5 + 0.2})`;
            ctx.beginPath();
            ctx.arc(x, y, size, 0, Math.PI * 2);
            ctx.fill();
        }
        
        // å·¦å´è¡›æ˜Ÿ
        drawSatellite(ctx, 80, 100, -0.3);
        // å³å´è¡›æ˜Ÿ
        drawSatellite(ctx, canvas.width - 80, 100, 0.3);
        
        // è¡›æ˜Ÿè¨Šè™Ÿç·š
        ctx.strokeStyle = 'rgba(79, 172, 254, 0.4)';
        ctx.setLineDash([5, 10]);
        ctx.lineWidth = 2;
        // å·¦è¡›æ˜Ÿåˆ°ä¸­å¤®
        ctx.beginPath();
        ctx.moveTo(120, 130);
        ctx.lineTo(canvas.width / 2, 200);
        ctx.stroke();
        // å³è¡›æ˜Ÿåˆ°ä¸­å¤®
        ctx.beginPath();
        ctx.moveTo(canvas.width - 120, 130);
        ctx.lineTo(canvas.width / 2, 200);
        ctx.stroke();
        ctx.setLineDash([]);
        
        // ä¸»è³‡è¨Šé¢æ¿
        const panelX = canvas.width / 2 - 350;
        const panelY = 150;
        const panelW = 700;
        const panelH = 320;
        
        // é¢æ¿å¤–æ¡†ç™¼å…‰
        ctx.shadowColor = '#4facfe';
        ctx.shadowBlur = 30;
        ctx.strokeStyle = '#4facfe';
        ctx.lineWidth = 2;
        roundRect(ctx, panelX, panelY, panelW, panelH, 20, false, true);
        
        // é¢æ¿èƒŒæ™¯
        ctx.shadowBlur = 0;
        ctx.fillStyle = 'rgba(10, 20, 40, 0.85)';
        roundRect(ctx, panelX, panelY, panelW, panelH, 20, true, false);
        
        // é¢æ¿å…§æ¡†
        ctx.strokeStyle = 'rgba(79, 172, 254, 0.5)';
        ctx.lineWidth = 1;
        roundRect(ctx, panelX + 10, panelY + 10, panelW - 20, panelH - 20, 15, false, true);
        
        // åŸå¸‚åç¨±
        ctx.fillStyle = '#ffffff';
        ctx.font = 'bold 72px "Noto Sans TC", sans-serif';
        ctx.textAlign = 'center';
        ctx.shadowColor = '#4facfe';
        ctx.shadowBlur = 20;
        ctx.fillText(w.city, canvas.width / 2, panelY + 90);
        ctx.shadowBlur = 0;
        
        // æ—¥æœŸ
        const today = new Date();
        const dateStr = `${today.getFullYear()}å¹´${today.getMonth()+1}æœˆ${today.getDate()}æ—¥`;
        ctx.fillStyle = '#8ec8f8';
        ctx.font = '28px "Noto Sans TC", sans-serif';
        ctx.fillText(dateStr, canvas.width / 2, panelY + 140);
        
        // æº«åº¦
        ctx.fillStyle = '#00f2fe';
        ctx.font = 'bold 56px "Noto Sans TC", sans-serif';
        ctx.shadowColor = '#00f2fe';
        ctx.shadowBlur = 15;
        ctx.fillText(`${w.temp}Â°C`, canvas.width / 2, panelY + 220);
        ctx.shadowBlur = 0;
        
        // å¤©æ°£æè¿°
        ctx.fillStyle = '#aaddff';
        ctx.font = '32px "Noto Sans TC", sans-serif';
        ctx.fillText(w.description, canvas.width / 2, panelY + 275);
        
        // å¤©æ°£åœ–ç¤ºï¼ˆå³ä¸Šè§’ï¼‰
        ctx.font = '80px sans-serif';
        ctx.fillText(w.icon, panelX + panelW - 80, panelY + 100);
        
        // API ä¾†æºæ¨™èªŒï¼ˆå·¦ä¸‹è§’ï¼‰
        ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
        ctx.font = '18px sans-serif';
        ctx.textAlign = 'left';
        ctx.fillText('ğŸ“¡ ' + w.apiSource, panelX + 30, panelY + panelH - 30);
        
        // åº•éƒ¨è³‡è¨Šå€
        const infoY = panelY + panelH + 40;
        
        // è©³ç´°è³‡è¨Šå¡ç‰‡
        const cardW = 160;
        const cardH = 80;
        const cardGap = 20;
        const startX = canvas.width / 2 - (cardW * 4 + cardGap * 3) / 2;
        
        const infoData = [
            { icon: 'ğŸŒ¡ï¸', label: 'é«”æ„Ÿ', value: `${w.feels}Â°C` },
            { icon: 'ğŸ’§', label: 'æ¿•åº¦', value: `${w.humidity}%` },
            { icon: 'ğŸ’¨', label: 'é¢¨é€Ÿ', value: `${w.wind}m/s` },
            { icon: 'â˜ï¸', label: 'é›²é‡', value: w.clouds != null ? `${w.clouds}%` : '--' }
        ];
        
        infoData.forEach((info, i) => {
            const x = startX + i * (cardW + cardGap);
            
            // å¡ç‰‡èƒŒæ™¯
            ctx.fillStyle = 'rgba(79, 172, 254, 0.15)';
            ctx.strokeStyle = 'rgba(79, 172, 254, 0.4)';
            ctx.lineWidth = 1;
            roundRect(ctx, x, infoY, cardW, cardH, 12, true, true);
            
            // åœ–ç¤º
            ctx.font = '28px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(info.icon, x + cardW / 2, infoY + 30);
            
            // æ•¸å€¼
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 22px "Noto Sans TC", sans-serif';
            ctx.fillText(info.value, x + cardW / 2, infoY + 60);
        });
        
        // è¡›æ˜Ÿè³‡è¨Š
        ctx.fillStyle = 'rgba(79, 172, 254, 0.8)';
        ctx.font = '20px "Noto Sans TC", sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText(`ğŸ›°ï¸ ${w.satellite.name}`, canvas.width / 2, infoY + cardH + 40);
        
        // åº§æ¨™
        ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
        ctx.font = '16px monospace';
        ctx.fillText(`ğŸ“ ${w.lat.toFixed(4)}Â°N, ${w.lon.toFixed(4)}Â°E`, canvas.width / 2, infoY + cardH + 70);
        
        // æ›´æ–°æ™‚é–“
        ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
        ctx.font = '14px "Noto Sans TC", sans-serif';
        ctx.fillText(`ğŸ• ${w.updateTime}`, canvas.width / 2, canvas.height - 20);
        
        // å¦‚æœæ˜¯é›¨å¤©ï¼Œæ·»åŠ é›¨æ»´æ•ˆæœ
        if (/Rain|rain|é›¨|Drizzle/.test(w.description)) {
            ctx.strokeStyle = 'rgba(150, 200, 255, 0.4)';
            ctx.lineWidth = 1;
            for (let i = 0; i < 100; i++) {
                const x = Math.random() * canvas.width;
                const y = Math.random() * canvas.height;
                const len = Math.random() * 20 + 10;
                ctx.beginPath();
                ctx.moveTo(x, y);
                ctx.lineTo(x - 5, y + len);
                ctx.stroke();
            }
        }
        
        return canvas.toDataURL('image/png');
    }
    
    // ç¹ªè£½è¡›æ˜Ÿ
    function drawSatellite(ctx, x, y, rotation) {
        ctx.save();
        ctx.translate(x, y);
        ctx.rotate(rotation);
        
        // è¡›æ˜Ÿæœ¬é«”
        ctx.fillStyle = '#4facfe';
        ctx.fillRect(-15, -8, 30, 16);
        
        // å¤ªé™½èƒ½æ¿
        ctx.fillStyle = '#1a3a5c';
        ctx.strokeStyle = '#4facfe';
        ctx.lineWidth = 1;
        ctx.fillRect(-55, -5, 35, 10);
        ctx.strokeRect(-55, -5, 35, 10);
        ctx.fillRect(20, -5, 35, 10);
        ctx.strokeRect(20, -5, 35, 10);
        
        // å¤ªé™½èƒ½æ¿æ ¼ç·š
        ctx.strokeStyle = 'rgba(79, 172, 254, 0.5)';
        for (let i = 1; i < 5; i++) {
            ctx.beginPath();
            ctx.moveTo(-55 + i * 7, -5);
            ctx.lineTo(-55 + i * 7, 5);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(20 + i * 7, -5);
            ctx.lineTo(20 + i * 7, 5);
            ctx.stroke();
        }
        
        // å¤©ç·š
        ctx.strokeStyle = '#4facfe';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(0, 8);
        ctx.lineTo(0, 25);
        ctx.stroke();
        
        // è¨Šè™Ÿæ³¢
        ctx.strokeStyle = 'rgba(79, 172, 254, 0.6)';
        ctx.lineWidth = 1;
        for (let i = 1; i <= 3; i++) {
            ctx.beginPath();
            ctx.arc(0, 25, i * 8, 0.3 * Math.PI, 0.7 * Math.PI);
            ctx.stroke();
        }
        
        ctx.restore();
    }
    
    // åœ“è§’çŸ©å½¢
    function roundRect(ctx, x, y, w, h, r, fill, stroke) {
        ctx.beginPath();
        ctx.moveTo(x + r, y);
        ctx.lineTo(x + w - r, y);
        ctx.quadraticCurveTo(x + w, y, x + w, y + r);
        ctx.lineTo(x + w, y + h - r);
        ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
        ctx.lineTo(x + r, y + h);
        ctx.quadraticCurveTo(x, y + h, x, y + h - r);
        ctx.lineTo(x, y + r);
        ctx.quadraticCurveTo(x, y, x + r, y);
        ctx.closePath();
        if (fill) ctx.fill();
        if (stroke) ctx.stroke();
    }
    
    // ä¸Šå‚³åˆ° ImgBB
    async function uploadToImgBB(base64) {
        const img = base64.replace(/^data:image\/\w+;base64,/, '');
        const formData = new FormData();
        formData.append('key', cfg.imgbbKey);
        formData.append('image', img);
        
        const r = await fetch('https://api.imgbb.com/1/upload', {
            method: 'POST',
            body: formData
        });
        const d = await r.json();
        if (d.success) return d.data.url;
        throw new Error(d.error?.message || 'ä¸Šå‚³å¤±æ•—');
    }
    
    function showPage(page, btn) {
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        if(btn) btn.classList.add('active');
        if(page==='settings') document.getElementById('settings').classList.add('show');
        else document.getElementById('settings').classList.remove('show');
    }
    function closeSetting() { document.getElementById('settings').classList.remove('show'); }
    
    function showLoad(show, text) {
        document.getElementById('loading').classList.toggle('show', show);
        if(text) document.getElementById('loadingText').textContent = text;
    }
    function toast(msg) {
        const t = document.getElementById('toast');
        t.textContent = msg;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 2500);
    }
    </script>
</body>
</html>
